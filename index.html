<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ —Å–µ–º—å–∏ –ï—Å–º—É—Ö–∞–Ω–æ–≤—ã—Ö - FamilyTreeJS</title>
    <script src="familytree.js"></script>
    <style>
        html,body{
            width: 100%;
            height: 100%;
            padding: 0;
            margin:0;
            overflow: hidden;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        #tree {
            width: 100%;
            height: 800px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: white;
        }
        
        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .controls button {
            margin: 0 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .controls button:hover {
            background: #2980b9;
        }
        
        .controls button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        .calendar-link {
            display: inline-block;
            margin: 0 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #27ae60;
            color: white;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .calendar-link:hover {
            background: #229954;
            color: white;
            text-decoration: none;
        }
        #stats{
            display: none;
        }
    </style>

</head>
<body>
    <h1>Yesmukhanov Family Tree</h1>
    
    <div class="stats" id="stats">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
    
    <div class="controls">
        <!-- <a href="family-birthdays.ics" class="calendar-link">üìÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</a> -->
        <a href="#" onclick="addToCalendar(); return false;" class="calendar-link">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</a> 
        <!-- <button onclick="toggleFullscreen()">full screen</button> -->
    </div>
    
    <div id="tree"></div>

    <script src="family-data.js"></script>
    <script src="convert-data.js"></script>
    <script>
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç FamilyTreeJS
        const familyNodes = convertToFamilyTreeFormat(FAMILY_DATA);
        
        // –°–æ–∑–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
        FamilyTree.templates.myTemplate = Object.assign({}, FamilyTree.templates.base);
        FamilyTree.templates.myTemplate.size = [200, 80];
        FamilyTree.templates.myTemplate.node = 
            '<rect x="0" y="0" height="80" width="200" fill="#ffffff" stroke-width="2" stroke="#4a90e2" rx="10" ry="10"></rect>';
        
        // –ú—É–∂—Å–∫–æ–π —à–∞–±–ª–æ–Ω
        FamilyTree.templates.myTemplateMale = Object.assign({}, FamilyTree.templates.myTemplate);
        FamilyTree.templates.myTemplateMale.node = 
            '<rect x="0" y="0" height="80" width="200" fill="#e6f3ff" stroke-width="2" stroke="#4a90e2" rx="10" ry="10"></rect>';
        
        // –ñ–µ–Ω—Å–∫–∏–π —à–∞–±–ª–æ–Ω
        FamilyTree.templates.myTemplateFemale = Object.assign({}, FamilyTree.templates.myTemplate);
        FamilyTree.templates.myTemplateFemale.node = 
            '<rect x="0" y="0" height="80" width="200" fill="#ffe6f3" stroke-width="2" stroke="#e24a90" rx="10" ry="10"></rect>';
        
        // –ü–æ–ª—è –¥–ª—è –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤
        FamilyTree.templates.myTemplate.field_0 = 
            '<text data-width="180" data-text-overflow="ellipsis" style="font-size: 14px; font-weight: bold;" fill="#333" x="100" y="25" text-anchor="middle">{val}</text>';
        FamilyTree.templates.myTemplate.field_1 = 
            '<text data-width="180" data-text-overflow="ellipsis" style="font-size: 12px;" fill="#666" x="100" y="45" text-anchor="middle">{val}</text>';
        FamilyTree.templates.myTemplate.field_2 = 
            '<text data-width="180" data-text-overflow="ellipsis" style="font-size: 10px;" fill="#999" x="100" y="60" text-anchor="middle">{val} –ª–µ—Ç</text>';
            
        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–ª—è –∫ –º—É–∂—Å–∫–æ–º—É –∏ –∂–µ–Ω—Å–∫–æ–º—É —à–∞–±–ª–æ–Ω–∞–º
        FamilyTree.templates.myTemplateMale.field_0 = FamilyTree.templates.myTemplate.field_0;
        FamilyTree.templates.myTemplateMale.field_1 = FamilyTree.templates.myTemplate.field_1;
        FamilyTree.templates.myTemplateMale.field_2 = FamilyTree.templates.myTemplate.field_2;
        
        FamilyTree.templates.myTemplateFemale.field_0 = FamilyTree.templates.myTemplate.field_0;
        FamilyTree.templates.myTemplateFemale.field_1 = FamilyTree.templates.myTemplate.field_1;
        FamilyTree.templates.myTemplateFemale.field_2 = FamilyTree.templates.myTemplate.field_2;
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        function updateStats() {
            const totalPeople = FAMILY_DATA.people.length;
            const maleCount = FAMILY_DATA.people.filter(p => p.gender === 'male').length;
            const femaleCount = FAMILY_DATA.people.filter(p => p.gender === 'female').length;
            const relationships = FAMILY_DATA.relationships.length;
            const peopleWithBirthDates = FAMILY_DATA.people.filter(p => p.birth && p.birth.date).length;
            
            document.getElementById('stats').innerHTML = `
                <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–º—å–∏:</strong>
                –í—Å–µ–≥–æ –ª—é–¥–µ–π: <strong>${totalPeople}</strong> |
                –ú—É–∂—á–∏–Ω: <strong>${maleCount}</strong> |
                –ñ–µ–Ω—â–∏–Ω: <strong>${femaleCount}</strong> |
                –°–≤—è–∑–µ–π: <strong>${relationships}</strong> |
                –° –¥–∞—Ç–∞–º–∏ —Ä–æ–∂–¥–µ–Ω–∏—è: <strong>${peopleWithBirthDates}</strong>
            `;
        }
        
        // –ù–∞–π—Ç–∏ –¥–µ–¥—É—à–∫—É –ú—É—Ö–∞–º–µ—Ç—Å–µ–∏—Ç–∞
        const grandfather = familyNodes.find(node => 
            node.name.includes('–ú—É—Ö–∞–º–µ—Ç—Å–µ–∏—Ç') || node.name.includes('–î–µ–¥—É—à–∫–∞')
        );
        
        console.log('–ù–∞–π–¥–µ–Ω –¥–µ–¥—É—à–∫–∞:', grandfather);
        
        // –°–æ–∑–¥–∞—Ç—å —Å–µ–º–µ–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
        const family = new FamilyTree("#tree", {
            // –ö–æ—Ä–Ω–µ–≤–æ–π —É–∑–µ–ª - –¥–µ–¥—É—à–∫–∞
            roots: [grandfather ? grandfather.id : 1],
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
            template: "myTemplate",
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            orientation: FamilyTree.orientation.left,
            scaleInitial: 0.6,
            mouseScrool: FamilyTree.none,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∑–ª–æ–≤
            nodeBinding: {
                field_0: "name",
                field_1: "birthDate",
                field_2: "age"
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–æ–≤
            tags: {
                "male": {
                    template: "myTemplateMale"
                },
                "female": {
                    template: "myTemplateFemale"
                }
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π
            siblingSeparation: 80,
            subtreeSeparation: 80,
            levelSeparation: 150,
            editForm: null,
            enableSearch: false,
            
            // –î–∞–Ω–Ω—ã–µ - –≤—Å–µ —É–∑–ª—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ—Ä–Ω—è
            nodes: familyNodes.map(node => {
                const nodeWithTemplate = {
                    id: node.id,
                    name: node.name,
                    gender: node.gender,
                    tags: [node.gender],
                    birthDate: node.birthDate || "",
                    age: node.age || ""
                };
                
                // –î–æ–±–∞–≤–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª–µ–π –µ—Å–ª–∏ –µ—Å—Ç—å
                if (node.fid) nodeWithTemplate.fid = node.fid;
                if (node.mid) nodeWithTemplate.mid = node.mid;
                if (node.pids && node.pids.length > 0) nodeWithTemplate.pids = node.pids;
                
                return nodeWithTemplate;
            })
        });
        
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        family.on('click', function(sender, args) {
            console.log('–ö–ª–∏–∫ –ø–æ —É–∑–ª—É:', args);
        });
        
        family.on('dbclick', function(sender, args) {
            console.log('–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —É–∑–ª—É:', args);
        });
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function safeFit() {
            try {
                family.fit();
                console.log('–†–∞–∑–º–µ—Ä –ø–æ–¥–æ–≥–Ω–∞–Ω');
            } catch (e) {
                console.log('–ü–æ–¥–≥–æ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e.message);
                alert('–ü–æ–¥–≥–æ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        }
        
        function safeCenter() {
            try {
                family.center();
                console.log('–î–µ—Ä–µ–≤–æ –æ—Ç—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ');
            } catch (e) {
                console.log('–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', e.message);
                alert('–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
            }
        }
        
        function showDebugInfo() {
            console.log('=== –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===');
            console.log('–í—Å–µ–≥–æ —É–∑–ª–æ–≤:', familyNodes.length);
            console.log('–û–±—ä–µ–∫—Ç family:', family);
            console.log('–î–∞–Ω–Ω—ã–µ —É–∑–ª–æ–≤:', familyNodes);
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
            const issues = [];
            familyNodes.forEach(node => {
                if (node.fid && !familyNodes.find(n => n.id === node.fid)) {
                    issues.push(`–û—Ç–µ—Ü —Å ID ${node.fid} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è ${node.name}`);
                }
                if (node.mid && !familyNodes.find(n => n.id === node.mid)) {
                    issues.push(`–ú–∞—Ç—å —Å ID ${node.mid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è ${node.name}`);
                }
                if (node.pids) {
                    node.pids.forEach(pid => {
                        if (!familyNodes.find(n => n.id === pid)) {
                            issues.push(`–°—É–ø—Ä—É–≥ —Å ID ${pid} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è ${node.name}`);
                        }
                    });
                }
            });
            
            if (issues.length > 0) {
                console.log('–ü–†–û–ë–õ–ï–ú–´ –í –î–ê–ù–ù–´–•:');
                issues.forEach(issue => console.log('- ' + issue));
            } else {
                console.log('–î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã');
            }
            
            alert(`–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏. –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: ${issues.length}`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ –¥–µ—Ä–µ–≤–∞
        function expandAll() {
            console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë –¥–µ—Ä–µ–≤–æ...');
            
            setTimeout(() => {
                try {
                    family.fit();
                } catch (e) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–æ–≥–Ω–∞—Ç—å —Ä–∞–∑–º–µ—Ä');
                }
            }, 500);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –¥–µ–¥—É—à–∫–µ
        function collapseAll() {
            console.log('–¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –¥–µ–¥—É—à–∫–µ...');
            
            setTimeout(() => {
                try {
                    family.center();
                } catch (e) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ü–µ–Ω—Ç—Ä–æ–≤–∞—Ç—å');
                }
            }, 500);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function addToCalendar() {
            // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ iCal —Ñ–∞–π–ª–∞
            const icalContent = generateICalContent();
            
            // –°–æ–∑–¥–∞–µ–º blob –∏ —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const blob = new Blob([icalContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const link = document.createElement('a');
            link.href = url;
            link.download = 'family-birthdays-complete.ics';
            link.style.display = 'none';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ DOM –∏ –∫–ª–∏–∫–∞–µ–º –ø–æ –Ω–µ–π
            document.body.appendChild(link);
            link.click();
            
            // –û—á–∏—â–∞–µ–º
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            showMessage('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ–±–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫.', 'success');
        }
        
        // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function createCompleteCalendar() {
            const icalContent = generateICalContent();
            
            // –°—á–∏—Ç–∞–µ–º —Å–æ–±—ã—Ç–∏—è
            const eventCount = (icalContent.match(/BEGIN:VEVENT/g) || []).length;
            console.log(`–°–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å ${eventCount} —Å–æ–±—ã—Ç–∏—è–º–∏`);
            
            // –°–æ–∑–¥–∞–µ–º blob –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞
            const blob = new Blob([icalContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            const calendarLink = document.querySelector('.calendar-link');
            if (calendarLink) {
                calendarLink.href = url;
                calendarLink.download = 'family-birthdays-complete.ics';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ iCal —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        function generateICalContent() {
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            let icalContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Yesmukhanov Family//Family Tree//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:Yesmukhanov Family Birthdays',
                'X-WR-CALDESC:Birthdays of Yesmukhanov family members',
                'X-WR-TIMEZONE:Asia/Almaty'
            ];

            let eventCount = 0;
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
            FAMILY_DATA.people.forEach((person) => {
                if (person.birth && person.birth.date && person.birth.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const birthDate = person.birth.date;
                    const [year, month, day] = birthDate.split('-');
                    const displayName = person.name.display || `${person.name.given || ''} ${person.name.family || ''}`.trim();
                    
                    if (displayName && month && day) {
                        eventCount++;
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–¥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π
                        const currentYear = now.getFullYear();
                        const eventDate = `${currentYear}${month}${day}`;
                        
                        // –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è –∫–∞–∫ –µ–∂–µ–≥–æ–¥–Ω–æ–µ
                        const event = [
                            'BEGIN:VEVENT',
                            `UID:birthday-${person.id}@yesmukhanov-family.com`,
                            `DTSTAMP:${timestamp}`,
                            `DTSTART;VALUE=DATE:${eventDate}`,
                            `SUMMARY:üéÇ ${escapeICalText(displayName)} - –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è`,
                            `DESCRIPTION:–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${escapeICalText(displayName)}. –†–æ–¥–∏–ª—Å—è ${day}.${month}.${year}`,
                            'RRULE:FREQ=YEARLY',
                            'CATEGORIES:BIRTHDAY,FAMILY',
                            'CLASS:PUBLIC',
                            'STATUS:CONFIRMED',
                            'TRANSP:TRANSPARENT',
                            'END:VEVENT'
                        ];
                        
                        icalContent.push(...event);
                    }
                }
            });

            icalContent.push('END:VCALENDAR');
            
            console.log(`–°–æ–∑–¥–∞–Ω–æ —Å–æ–±—ã—Ç–∏–π: ${eventCount}`);
            return icalContent.join('\r\n');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è iCal
        function escapeICalText(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')
                .replace(/;/g, '\\;')
                .replace(/,/g, '\\,')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function showMessage(message, type = 'info') {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (type === 'success') {
                messageDiv.style.background = '#27ae60';
            } else if (type === 'error') {
                messageDiv.style.background = '#e74c3c';
            } else {
                messageDiv.style.background = '#3498db';
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
            document.body.appendChild(messageDiv);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        function toggleFullscreen() {
            const treeElement = document.getElementById('tree');
            if (!document.fullscreenElement) {
                treeElement.requestFullscreen().then(() => {
                    treeElement.style.height = '100vh';
                    setTimeout(() => family.draw(), 100);
                });
            } else {
                document.exitFullscreen().then(() => {
                    treeElement.style.height = '800px';
                    setTimeout(() => family.draw(), 100);
                });
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                document.getElementById('tree').style.height = '800px';
                setTimeout(() => family.draw(), 100);
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            createCompleteCalendar();
            
            // –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ä–µ–≤–∞
            family.on('init', function() {
                console.log('–î–µ—Ä–µ–≤–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                setTimeout(() => {
                    try {
                        family.center();
                    } catch (e) {
                        console.log('–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
                    }
                }, 500);
            });
        });
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log('–í—Å–µ–≥–æ —É–∑–ª–æ–≤:', familyNodes.length);
        console.log('–î–∞–Ω–Ω—ã–µ —É–∑–ª–æ–≤:', familyNodes);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
        familyNodes.forEach(node => {
            if (node.fid && !familyNodes.find(n => n.id === node.fid)) {
                console.warn(`–û—Ç–µ—Ü —Å ID ${node.fid} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è ${node.name}`);
            }
            if (node.mid && !familyNodes.find(n => n.id === node.mid)) {
                console.warn(`–ú–∞—Ç—å —Å ID ${node.mid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è ${node.name}`);
            }
            if (node.pids) {
                node.pids.forEach(pid => {
                    if (!familyNodes.find(n => n.id === pid)) {
                        console.warn(`–°—É–ø—Ä—É–≥ —Å ID ${pid} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è ${node.name}`);
                    }
                });
            }
        });
    </script>
    <style type="text/css">
        .bft-search {
            position: fixed !important;
            top: 70px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 1000 !important;
            background: rgba(255, 255, 255, 0.95) !important;
            border: 2px solid #3498db !important;
            border-radius: 25px !important;
            padding: 5px 10px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        .bft-search input {
            border: none !important;
            outline: none !important;
            padding: 8px 15px !important;
            font-size: 14px !important;
            border-radius: 20px !important;
            width: 250px !important;
        }
        
        .bft-search input:focus {
            box-shadow: 0 0 5px #3498db !important;
        }
    </style>
</body>
</html>